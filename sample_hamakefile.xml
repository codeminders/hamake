<?xml version="1.0" encoding="UTF-8"?>

<project default="build" name="recommendations">

  <config>
    <dfs>
      <thriftAPI host="localhost" port="5009"/>
    </dfs>
  </config>
  
  <property name="dfsroot" value="/dfs"/>
  <property name="scriptdir" value="/home/user/hadoop-scripts"/>
  <property name="numreducers" value="14" />

  <map name="access2related">
    <description>
      Extract some data from access logs
    </description>
    <input>
      <path location="%(dfsroot)s/access_logs" mask="*.log"/>
    </input>
    <dependencies/>
    <output>
      <path location="%(dfsroot)s/related_logs1"/>
    </output>
    <task jar="%(scriptdir)s/datamining.jar" main="Access2Related">
      <pathparam type="inputfile"/>
      <pathparam type="outputfile"/>
      <jobconfparam name="us.imageshack.numreducers" value="%(numreducers)s" />
    </task>
  </map>

  <reduce name="calc">
    <description>
      Calculate recommendation.  Byproduct is a file containing
      max. cluster ID
    </description>
    <input>
      <path location="%(dfsroot)s/related_logs1" mask="*.log"/>
      <path location="%(dfsroot)s" filename="private_img.tsv"/>
      <path location="%(dfsroot)s/related/clusters" mask="cluster*.tsv"/>
    </input>
    <output>
      <path location="%(dfsroot)s/related/intermediate" mask="*.tsv"/>
      <path location="%(dfsroot)s/related" filename="max_cluster.tsv"/>
    </output>
    <pig script="%(scriptdir)s/recommendations.pig">
      <pigparam name="jarpath" value="%(scriptdir)s"/>
      <pathparam name="logs" type="input" number="0"/>
      <pathparam name="private" type="input" number="1"/>
      <pathparam name="clusters" type="input" number="2"/>
      <pathparam name="intermediate" type="output" number="0"/>
      <pathparam name="maxcluster" type="output" number="1"/>
    </pig>
  </reduce>

  <reduce name="export">
    <description>
      Export from 'flat' format into mysql table dumps, ready to be
      imported to DB.
    </description>
    <input>
      <path location="%(dfsroot)s/related/intermediate" mask="*.tsv"/>
      <path location="%(dfsroot)s/related" filename="max_cluster.tsv"/>
    </input>
    <output>
      <path location="%(dfsroot)s/related/clusters"
            filename="clusters-%(timestamp)s.tsv"
            generation="1"/>
      <path location="%(dfsroot)s/related" filename="related_images.tsv"/>
    </output>
    <task jar="%(scriptdir)s/datamining.jar" main="ExportRecommendations">
      <pathparam type="output" number="1"/>
      <pathparam type="output" number="0"/>
      <pathparam type="input" number="1"/>
      <pathparam type="input" number="0" mask="expand"/>
    </task>
  </reduce>

  <map name="rec_usage">
    <description>
      extract some other data from access logs
    </description>
    <input>
      <path location="%(dfsroot)s/access_logs" mask="*.log"/>
    </input>
    <dependencies/>
    <output>
      <path location="%(dfsroot)s/related/usage"/>
    </output>
    <task jar="datamining.jar" main="RecommendationsUsage">
      <pathparam type="outputfile"/>
      <pathparam type="inputfile"/>
    </task>
  </map>


</project>
