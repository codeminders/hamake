<project name="test" default="jar-listings">
	<property name="outdir" value="build/test" />
	<property name="dist" value="dist" />
	<property name="scripts" value="src/scripts" />
	<file id="logfile" path="${outdir}/logs/histogram.log" />
	<file id="histogram" path="${outdir}/class-size-histogram" />

	<foreach name="jar-listings">
		<input>
			<fileset path="${libdir}/lib" mask="*.jar" />
		</input>
		<output>
			<file id="file-listing" path="${outdir}/jar-listings/$#.txt" />
		</output>
		<mapreduce main="com.codeminders.hamake.examples.JarListing" jar="${dist}/hamake-examples-1.0.jar">
			<description>description</description>
			<parameter>
				<literal value="$_" />
			</parameter>
			<parameter>
				<reference idref="file-listing" />
			</parameter>
		</mapreduce>
	</foreach>

	<foreach name="filter-listing">
		<input>
			<fileset path="${outdir}/jar-listings" />
		</input>
		<output>
			<set id="listing-processed">
				<file path="${outdir}/jar-listings-0/$@" />
				<file path="${outdir}/jar-listings-1/$@" />
				<!-- this does not make any sense, just for demo -->
			</set>
		</output>
		<mapreduce jar="${dist}/hamake-examples-1.0.jar" main="com.codeminders.hamake.examples.JarListingFilter">
			<parameter>
				<literal value="$_" />
			</parameter>
			<parameter concat_function="space" processing_function="identity">
				<reference idref="listing-processed" />
			</parameter>
		</mapreduce>
	</foreach>

	<fold name="histogram">
		<dependency>
			<file path="${scripts}/bin-size.property" />
		</dependency>
		<input generation="1">
			<fileset id="listings-0" path="${outdir}/jar-listings-0" />
		</input>
		<input>
			<fileset id="listings-1" path="${outdir}/jar-listings-1" />
		</input>
		<output>
			<include idref="logfile" />
			<include idref="histogram" />
		</output>

		<mapreduce jar="${dist}/hamake-examples-1.0.jar" main="com.codeminders.hamake.examples.ClassSizeHistogram">
			<parameter>
				<reference idref="logfile" />
			</parameter>
			<parameter concat_function="comma" processing_function="identity">
				<reference reference="listings-0" expand="list" />
				<reference reference="listings-1" expand="list" />
			</parameter>
			<parameter>
				<reference idref="histogram" />
			</parameter>
		</mapreduce>
	</fold>

	<fold name="median">
		<input>
			<include idref="histogram" />
		</input>
		<output expiration="1h">
			<file id="median" path="${outdir}/class-size-median-bin" />
		</output>
		<pig script="${scripts}/median.pig">
			<parameter>
				<reference idref="histogram" />
			</parameter>
			<parameter>
				<reference idref="median" />
			</parameter>
		</pig>
	</fold>
</project>